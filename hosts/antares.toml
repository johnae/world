system = "x86_64-linux"

[config]
publicKey = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJgkTCs3JTN934N8RkPhuDwijFgFOEXt734tB7aQz57Z"
syncthingDeviceID = "CI5DK5E-JLWEOXB-6TUV244-SV6MLGO-R6AY7XQ-ZOFCIQW-G3U2DAS-BK5EXAL"

profiles = [
  "profiles/hardware/usbcore",
  "profiles/hardware/z16",
  "profiles/default_fs",
  "profiles/greetd",
  "profiles/home-manager",
  "profiles/interception-tools",
  "profiles/laptop",
  "profiles/pamu2f",
  "profiles/pcscd",
  "profiles/state",
  "profiles/syncthing",
  "profiles/tailscale",
  "profiles/zram",
]

[config.programs.mosh]
enable = true

[config.boot.initrd.systemd]
enable = true

[config.boot.initrd.luks.devices]
cryptkey.crypttabExtraOpts = [ "fido2-device=auto" ]

[config.age.secrets]
spotnix = { file = "secrets/spotnix.age", owner = "1337" }
spotifyd = { file = "secrets/spotifyd.age", owner = "1337" }
wifi-networks.file = "secrets/wifi-networks.age"
wg-home.file = "secrets/antares/wg-home.age"
#wg-net.file = "secrets/antares/wg-net.age"
id_ed25519_agenda_updater = { file = "secrets/id_ed25519_agenda_updater.age", owner = "1337" }
id_ed25519_roam_updater = { file = "secrets/id_ed25519_roam_updater.age", owner = "1337" }
id_ed25519_bbph = { file = "secrets/id_ed25519_bbph.age", owner = "1337", path = "/home/john/.ssh/id_ed25519_bbph" }
id_ed25519_alt = { file = "secrets/id_ed25519_alt.age", owner = "1337", path = "/home/john/.ssh/id_ed25519_alt" }
id_rsa_alt = { file = "secrets/id_rsa_alt.age", owner = "1337", path = "/home/john/.ssh/id_rsa_alt" }
id_ed25519_alt_root = { file = "secrets/id_ed25519_alt.age", owner = "0", path = "/root/.ssh/id_ed25519" }
syncthing-cert = { file = "secrets/antares/syncthing-cert.age", owner = "1337" }
syncthing-key = { file = "secrets/antares/syncthing-key.age", owner = "1337" }
mbsync-insane = { file = "secrets/mbsync-insane.age", owner = "1337" }
mbsync-9000 = { file = "secrets/mbsync-9000.age", owner = "1337" }
authinfo = { file = "secrets/authinfo.age", owner = "1337", path = "/home/john/.authinfo" }
restic-env = { file = "secrets/restic.age", owner = "1337" }
restic-pw = { file = "secrets/restic-pw.age", owner = "1337" }
ts-gh-johnae = { file = "secrets/ts-gh-johnae.age", owner = "1337" }

[config.services.restic.backups.remote]
paths = [
  "/home/john/Development",
  "/home/john/Documents",
  "/home/john/Sync",
  "/home/john/Photos",
]
repository = "s3:https://b0850d27a4d43d7d0f8d36ebc6a1bfab.r2.cloudflarestorage.com/restic-9000-b147"
environmentFile = "/run/agenix/restic-env"
passwordFile = "/run/agenix/restic-pw"
initialize = true
timerConfig.OnCalendar = "*-*-* *:00:00"
timerConfig.RandomizedDelaySec = "5m"
extraBackupArgs = [
  "--exclude=\".direnv\"",
  "--exclude=\".terraform\"",
  "--exclude=\"node_modules\"",
]

[config.services.syncthing]
enable = true
user = "john"
group = "users"
openDefaultPorts = true
cert = "/run/agenix/syncthing-cert"
key = "/run/agenix/syncthing-key"
dataDir = "/home/john/.local/share/syncthing-data"

[config.services.syncthing.settings]
devices.s23ultra.id = "WIEQUVJ-5TNGRPN-YD4E47D-WEXXBZO-2AGHFQZ-2K4DDRB-DFSD2UZ-34OCBQ4"
devices.s8plus.id = "EI6DXMZ-3CMM3R3-LNJPFIF-CTXDVAG-2SXLOCY-4NEEZ3K-CYJBXU6-6W44TAV"
folders."/home/john/Sync".id = "sync"
folders."/home/john/Sync".devices = [
  "eris",
  "atlas",
  "polaris",
  "icarus",
  "titan",
  "sirius",
  "vela",
  "hyperion",
  "s23ultra",
  "s8plus"
]
folders."/home/john/Pictures".id = "pictures"
folders."/home/john/Pictures".devices = [
  "eris",
  "atlas",
  "sirius",
  "vela"
]
folders."/home/john/Photos".id = "photos"
folders."/home/john/Photos".devices = [
  "atlas",
  "eris",
  "icarus",
  "sirius",
  "vela",
  "s23ultra"
]
folders."/home/john/Photos".versioning.type = "staggered"
folders."/home/john/Photos".versioning.params.cleanInterval = "3600"
folders."/home/john/Photos".versioning.params.maxAge = "0"
folders."/home/john/Photos".versioning.params.versionsPath = "/home/john/Photos/stbackup"

[config.users.groups.john]
gid = 1337

[config.users.users.john]
uid = 1337
shell = "nushell"
hashedPassword = "$6$4nxtQ.7ukf3PCK4W$Jo74tGFkCoa.DEj.YlPMbbCseyoWtOkk4weSMZnX081gjDkWYJ7596JbqFaw29PxSBPKz2M75q0pqSydARDZ4."

[config.u2fMappings]
john = ["soJksM/D33aDVQt6vTGxPvwFmF3uQoYKLYfDXSaYxfroe6E4AXBK0wkAy7LfTACF1un1aYp58fNl0pLmVj/9yg==,JPuH+MSpS0DRYeg2+zFrvzeXgM5xcpKTdn7TwDqARz80iR5LXywWXuzMCo8Kw8snoPcm2rYedXXq3YzWdgDl+w==,es256,+presence", "CN6G3r3mfj74PIn5GidBvoT3TLs1nmbmKeyWo7uwY+rodWhxRzTwo4VeKopmQsSPkN1a2nKj6hDDfHUeZujjbQ==,PEvtpD3217glOzMzJMz7sPMEkH6WVljrdyQNLtdxdNFO8zpNAaVRRFXAVUXSza54srl5Iv86TqmjA1iv7Mp8gQ==,es256,+presence"]

[config.home-manager.users.john]
profiles = [
  "users/profiles/alacritty",
  "users/profiles/chromium",
  "users/profiles/dconf",
  "users/profiles/eww",
  "users/profiles/firefox",
  "users/profiles/fish",
  "users/profiles/foot",
  "users/profiles/git",
  "users/profiles/hyprland",
  "users/profiles/i3status-laptop",
  "users/profiles/kanshi",
  "users/profiles/kubie",
  "users/profiles/mako",
  "users/profiles/nushell",
  "users/profiles/obs",
  "users/profiles/pueue",
  "users/profiles/qutebrowser",
  "users/profiles/rbw",
  "users/profiles/river",
  "users/profiles/rofi",
  "users/profiles/spotifyd",
  "users/profiles/ssh",
  "users/profiles/starship",
  "users/profiles/sway",
  "users/profiles/tmux",
  "users/profiles/waybar",
  "users/profiles/wlsunset",
  #"users/profiles/spotnix",
]

[config.home-manager.users.john.programs.bat]
enable = true

[config.home-manager.users.john.programs.emacs]
enable = true
package = "${pkgs.my-emacs}"

[config.home-manager.users.john.services.emacs]
enable = true
package = "${pkgs.my-emacs}"
socketActivation.enable = true

[config.home-manager.users.john.systemd.user.services.emacs.Service]
Environment = [ "COLORTERM=truecolor" ]
LimitNOFILE = 16384

[config.home-manager.users.john.userinfo]
email = "john@insane.se"
fullName = "John Axel Eriksson"
githubUser = "johnae"
gitlabUser = "johnae"

[config.home-manager.users.john.programs.git]
extraConfig.user.signingKey = "key::sk-ssh-ed25519@openssh.com AAAAGnNrLXNzaC1lZDI1NTE5QG9wZW5zc2guY29tAAAAIJY3QSBIiRKN8/B3nHgCBDpauQBOftphOeuF2TaBHGQSAAAABHNzaDo="
extraConfig.gpg.format = "ssh"
extraConfig.commit.gpgSign = true
extraConfig.tag.forceSignAnnotated = true

[[config.home-manager.users.john.programs.git.includes]]
condition = "gitdir:~/Development/volvo/" ## note the IMPORTANT trailing slash
contents.user.email = "john.axel.eriksson@consultant.volvo.com"
contents.user.signingKey = "key::sk-ssh-ed25519@openssh.com AAAAGnNrLXNzaC1lZDI1NTE5QG9wZW5zc2guY29tAAAAIJsVshwPSDDs5lgly2P6Hv5t96NgASRezs66KvgLR99ZAAAACXNzaDp2b2x2bw=="
contents.commit.gpgSign = false ## skip this for now
contents.credential."https://github.com".helper = "${pkgs.scripts}/bin/rbw-git-creds github.com john.axel.eriksson@consultant.volvo.com"
contents.url."https://github.com".insteadOf = "ssh://git@github.com"

[config.home-manager.users.john.services.kanshi]
enable = true

[config.home-manager.users.john.programs.mbsync]
enable = true

[config.home-manager.users.john.services.mbsync]
enable = true
frequency = "*:0/5"

[config.home-manager.users.john.services.imapnotify]
enable = true

[config.home-manager.users.john.services.gitAutoSync.repos."~/Development/org-roam"]
repository = "git@github.com:johnae/org-roam"
sshKey = "/run/agenix/id_ed25519_roam_updater"

[config.home-manager.users.john.services.gitAutoSync.repos."~/Development/org-agenda"]
repository = "git@github.com:johnae/org-agenda"
sshKey = "/run/agenix/id_ed25519_agenda_updater"

[config.home-manager.users.john.accounts.email]
maildirBasePath = "Mail"

[config.home-manager.users.john.accounts.email.accounts.insane]
address = "john@insane.se"
primary = true
flavor = "gmail.com"
mbsync.enable = true
mbsync.create = "both"
mbsync.extraConfig.account.PipelineDepth = 10
passwordCommand = "${pkgs.coreutils}/bin/cat /run/agenix/mbsync-insane"
imapnotify.enable = true
imapnotify.boxes = [ "Inbox" ]
imapnotify.onNotify = "${pkgs.isync}/bin/mbsync insane"
imapnotify.onNotifyPost = "${pkgs.mu}/bin/mu index"

[config.home-manager.users.john.accounts.email.accounts.insane.mbsync.groups.insane.channels]
inbox.patterns = ["INBOX"]
inbox.extraConfig.Create = "both"
inbox.extraConfig.SyncState = "*"

all.farPattern = "[Gmail]/All Mail"
all.nearPattern = "All"
all.extraConfig.Create = "near"
all.extraConfig.SyncState = "*"

sent.farPattern = "[Gmail]/Sent Mail"
sent.nearPattern = "Sent"
sent.extraConfig.Create = "near"
sent.extraConfig.SyncState = "*"

trash.farPattern = "[Gmail]/Trash"
trash.nearPattern = "Trash"
trash.extraConfig.Create = "near"
trash.extraConfig.SyncState = "*"

drafts.farPattern = "[Gmail]/Drafts"
drafts.nearPattern = "Drafts"
drafts.extraConfig.Create = "near"
drafts.extraConfig.SyncState = "*"

[config.home-manager.users.john.accounts.email.accounts.9000]
address = "john@9000.dev"
userName = "john@9000.dev"
flavor = "fastmail.com"
primary = false
mbsync.enable = true
mbsync.create = "both"
passwordCommand = "${pkgs.coreutils}/bin/cat /run/agenix/mbsync-9000"
imapnotify.enable = true
imapnotify.boxes = [ "Inbox" ]
imapnotify.onNotify = "${pkgs.isync}/bin/mbsync 9000"
imapnotify.onNotifyPost = "${pkgs.mu}/bin/mu index"

[config.home-manager.users.john.accounts.email.accounts.9000.mbsync.groups.9000.channels]
all.patterns = ["*"]
all.extraConfig.Create = "near"
all.extraConfig.SyncState = "*"
all.extraConfig.CopyArrivalDate = "yes"
